name: niuma - Discussion Check

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue 编号"
        required: true
        type: number
      max_discussion_rounds:
        description: "最大讨论轮次（1-20）"
        required: false
        default: 5
        type: number
      visible_round_interval:
        description: "可见评论轮次间隔"
        required: false
        default: 1
        type: number
      visible_only_on_diff:
        description: "仅差异变化时可见评论"
        required: false
        default: true
        type: boolean

permissions:
  issues: write
  contents: read

jobs:
  # issues.labeled → bot:needs-discussion
  call-discuss-from-label:
    if: >
      github.event_name == 'issues' &&
      github.event.label.name == 'bot:needs-discussion' &&
      github.event.issue.pull_request == null
    uses: ./.github/workflows/niuma-discuss-reusable.yml
    with:
      repo: ${{ github.repository }}
      issue_number: ${{ format('{0}', github.event.issue.number) }}
    secrets: inherit

  # issue_comment.created → 非 bot 用户在非 PR 的 issue 上评论
  call-discuss-from-comment:
    if: >
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request == null &&
      !endsWith(github.actor, '[bot]') &&
      !contains(vars.BOT_ACTORS || '', github.actor) &&
      !contains(github.event.comment.body || '', '<!-- BOT:')
    uses: ./.github/workflows/niuma-discuss-reusable.yml
    with:
      repo: ${{ github.repository }}
      issue_number: ${{ format('{0}', github.event.issue.number) }}
    secrets: inherit

  # workflow_dispatch → 手动触发
  call-discuss-from-dispatch:
    if: github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/niuma-discuss-reusable.yml
    with:
      repo: ${{ github.repository }}
      issue_number: ${{ format('{0}', inputs.issue) }}
      max_discussion_rounds: ${{ fromJSON(inputs.max_discussion_rounds) }}
      visible_round_interval: ${{ fromJSON(inputs.visible_round_interval) }}
      visible_only_on_diff: ${{ fromJSON(inputs.visible_only_on_diff) }}
    secrets: inherit
